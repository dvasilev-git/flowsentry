name: Status Page Generator
on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  status-page:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Run monitoring checks
        run: |
          npm run check-uptime || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate status page
        run: |
          node scripts/generate-status-page.js
          ls -la ./status-page/
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Prepare status page for deployment
        run: |
          # Create a clean directory with only status page files
          mkdir -p ./deploy
          cp ./status-page/index.html ./deploy/
          cp ./status-page/api.json ./deploy/
          echo "FlowSentry Status Page" > ./deploy/README.md
          ls -la ./deploy/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy
          enable_jekyll: false
          cname: dvasilev-git.github.io
